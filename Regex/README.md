# 正则表达式

## 背景

好吧，在你抱怨前，我先一步承认这标题听起来很晦涩…呃，其实我也不想用正则表达式这个单词。

不如我们先抛开这个术语。让我们回到校园。

校园的生活总是枯燥乏味，但你不一样，悄咪咪地存了一些好康的。好东西需要分享，于是你搭了一个服务器。一面的时候，你骄傲地向面试官介绍着~~那些好康的~~你搭建服务器的过程。到现在为止，一切都在朝着好的方向发展。

可是有一天，你发现很多不速之客在偷窥你的好康的。

可恶！是谁走漏了风声！你要查出这些人是谁！不许康！

你连上了服务器，使用了`journalctl | grep ssh`指令。这条指令的意思是，获取系统日志，然后列出和远程登录相关的部分。关于 shell 指令，并不是我们这次挑战所要涵盖的内容。但是强烈建议完成 Linux 相关的试题。

终端上打印出来了这些内容。

```plain
Feb 07 00:03:35 hapkangde.com sshd[7223]: Invalid user webmail from 144.217.83.109 port 41292
Feb 07 23:16:27 haokangde.com sshd[481]: Disconnected from invalid user compta 62.210.69.91 port 47476 [preauth]
Feb 07 23:16:27 haokangde.com sshd[479]: Received disconnect from 70.45.243.146 port 43826:11: Bye Bye [preauth]
Feb 07 23:16:30 haokangde.com sshd[483]: Disconnected form invalid user preuba 70.
```

如果你愿意读一读，或许能猜到每一行是什么意思。我省略了一些内容。还有很多很多，具体有多少呢？实际上——

后面还有几千行！这好复杂......

你现在的直觉是什么？你需要一个工具，能够像人眼一样，但是能程序化模式化地阅读这些文字，同时提炼出你需要的信息。这样的工具，我们称之为正则表达式。

## 定义

>正则表达式(regular expression)描述了一种字符串匹配的模式（pattern），可以用来检查一个串是否含有某种子串、将匹配的子串替换或者从某个串中取出符合某个条件的子串等。

你可以简单地理解为，**正则表达式**就是按照一定的模式来处理一些文本。听起来是个很使用的工具，但是为什么叫正则表达式这么难懂的名字呢？这个其实是由于计算理论和编译原理的术语来的。这些学科是讨论程序如何从文本状的代码变为二进制程序的过程。如果你感兴趣的话，可以详细查阅相关的资料，不过它们和接下来要讲的内容，可以说是毫无关系。

## 基础

想马上揪出偷偷康你服务器的人？带侦探们，我们得寻找蛛丝马迹。

还记得我们一面题的名词解释吗？能够偷偷康你服务器的人很可能参加了咱们的一面，偷听了这些。我认为，或许可以先从那里入手，找找线索。

例如，我们可以通过他们名词解释的时候聊到的技术栈，推断他们偷偷康你服务器的概率。

如果把正则表达式比喻成一种按模式处理文本的语言的话，那么它也应该有自身的语法。最为基本的是，每一个你打出来的正则表达式对应于相应的匹配文本。这听起来有点拗口，举个例子来说——



/linux/               匹配               'linux'

/windows/      匹配               'windows'

/windows/      不能匹配      'linux'

/linux/              不能匹配       'windows'

注意到里面的斜杠了吗？斜杠就是表达一个正则表达式开始和结束的标记，正如单引号和双引号用来表示一个字符串的开始和结束的标记一样。从内容上来看，好像是一些废话...你不可能指望通过几个字符串儿来揪出那些偷偷康你服务器的人。

但是正则表达式强大在，有些字符是有特殊含义的，并不是一一对应的。而且注意我用的词是匹配，英文语境里叫 match。

### 中括号

我仿佛听见你在说：“喂！注意大小写！要严谨！这么粗心怎么抓凶手？”显然 linux 和 windows 的首字母是应该大写的，但是如果是聊天交谈的话，好像大家都不是很在意这个。怎么办？你可以设立 /linux/ /Linux/ /windows/ /Windows/ 这样四组正则来匹配，前两者匹配 linux，后两者匹配 windows。

这太不优雅了！正则提供了一个语法，使用"[]"(中括号)来包裹内容，里面每一个单独的字符都是或的逻辑。举例来说，

/[lL]inux/     匹配               'linux'  或 'Linux'

完整的表达可以参考下图，即一个或大写或小写的l（我知道图里长得很像数字1，但它真的是英文字母），后面跟着inux四个字母。

![图片](https://uploader.shimo.im/f/6xLB37IvwprOJORl.png!thumbnail?fileGuid=3KhKJxP3DQDHPvvV)

中括号里可以不只有两个字符。例如有个仔儿提到的关键词是 android，而且后面加了版本号，那么我们可以这么写

/[Aa]ndroid [0123456789]/

![图片](https://uploader.shimo.im/f/5NuYdHDV5y1u1yeR.png!thumbnail?fileGuid=3KhKJxP3DQDHPvvV)


相当于匹配，不管大小写开头的 android 后面跟一个0到9的数字。我知道没有安卓0这种东西，但是这对于抓住凶手来说不重要。

你有很多方法表示数字。其实 [0123456789] 可以用 [0-9] 来表示。中间的横杠，你可以理解为中文的“到”或者英文的“to”。

有些名词解释喜欢说安卓的，他们不加版本号，加的是代号。比如 Android P啊，Android O啊，甚至以前的 Android Marshmallow.

好在更牛的是，英文也可以用中括号。你可以用[a-x]表示从a到x的字母。甚至可以 [0-9a-Z] 表示从0到9或者大小写都算进去的a到Z。

注意：范围的字符值代表的是字符而已，并不能代表数值范围，比如[1-31]表示匹配一个数字，是1或者2或者3，而不是匹配一个数值在1到31之间的数。

回过神来，你突然想到，如果你就想找到那些打字带中括号的人（很奇怪的人对吧），那使用正则表达式的时候，中括号不就被吃了吗？

### 转义

且慢，在正则里，我们有转义符号，你可能在其他语言中也见到过。这个转移字符就是“\”，注意和标记正则的斜杠是相反的方向。在"\"后面的字符都会变成另一个意思。例如，中括号表示的是里面的字符或起来，但是"\[" 和 "\]" 就表示后面跟的是一个物理中括号。我猜你猜得到，“\\”就是一个物理引号。

其实对应于刚刚说的"[0-9]"或者"[a-z]"，我们也有些转义字符来表示它们。例如，"d" 表示的是识别字母"d"，而"\d"表示的是一个数字(digit)，和"[0-9]"等价。我们在中括号里，还会使用 "^"表示取反。例如，"[^0-9]"表示接下来的是一个非数字。在类似像d这样的转义字符里，大小写的区别往往就是取不取非的区别。例如 "w" 表示字母"w", "\w" 表示任意一个字母或数字，"\W" 表示所有的非字母非数字。

还有值得一提的是空白字符。我们往往使用 "\s" 来匹配空白字符。这里的空白字符包括空格，Tab键和换行。对，你猜到了，换行其实就是和你C时候的"\n"是一回事。

### 选择表达式

有时我们想匹配x或者y，如果x和y是单个字符，可以使用字符集，[abc]可以匹配a或b或c，如果x和y是多个字符，字符集就无能为力了，此时就要用到分组。

例如你只想找到那些说了任意“操作系统”的人，但不介意是android 或是 linux 或是 windows 或者是 macOS，iOS, 你都想要。

正则中用"|"来表示分组，"a|b"表示匹配"a"或者"b"的意思。

所以我们可以使用 "windows|linux|iOS" 可以匹配它们中的任意一个。

### 量词

现在我们讨论了很多或的逻辑，但是有些字符它出现的次数不是唯一的。很多字符可能有，很多字符可能无，很多字符可能出现很多次。

常用的量词有"?","+","*"。

如果你在正则表达式里看到一个"?"，不要紧张，这不是在阴阳怪气。它表示出现0次或1次。例如，当一个人和你说“我有苹果设备”的时候，你不在意他有几个苹果设备。所以，如果从字母的角度来说的话，apple可以加复数，也可以不加。那么我们就可以写一个 "apples?"


![图片](https://uploader.shimo.im/f/59J6HniW1Bk2YyMf.png!thumbnail?fileGuid=3KhKJxP3DQDHPvvV)


"+" 号则表示出现1次或更多。还是上一个问题，当一个人和你说“我有苹果设备”的时候，你不在意他有几个苹果设备。如果按单词来看的话，你不在意他说了几次 apple，那么这时候就可以写"(apple)+"。括号的意思是表示为一组，即整组的apple可以重复1次或更多次。稍后我们会继续详细讲解分组。

![图片](https://uploader.shimo.im/f/4mhMP52lNGBSUS3S.png!thumbnail?fileGuid=3KhKJxP3DQDHPvvV)

"*" 的意思是，可以重复任意次，0次到无穷次都行。 你可以自行找个例子：）

还有一种表示量词的方式是使用大括号内，标注重复的次数。可以把所有的候选项用逗号分割。还是那个苹果设备的例子。假如你收到了一个线索，有一个登录服务器的恶意用户可能有2台到5台苹果设备。那么你可以用这种方式来匹配这个线索。

![图片](https://uploader.shimo.im/f/fPPgFlfxkboNJUXa.png!thumbnail?fileGuid=3KhKJxP3DQDHPvvV)


对了，还有一个字符是“.”。通常教程会放在开头讲这个，但是我把它放到了最后。因为它是一个压轴的大杀器。它表示“任意字符”。如果一个正则表达式是 /.*/的话......哦不！它会匹配所有字符串！

### 开头和结尾

像我们之前讨论的，都在关注句子中是否出现某些关键词。可是如果你得到的线索是，这些偷窥狂，他们语句开头的口头禅是“I have a pen.”如果你想要匹配开头，你可以使用 "^"，匹配结尾，则使用"$"。有了"^"和"$"，相当于让你的句子完美match你给出的pattern。

例如，你找到了一个线索，就是这些嫌疑人很喜欢看 ".mp4"文件。而你的目的是，咳咳，找到这些所有文件名。你可以这么写/^(.*)\.mp4$/。这个有些超纲，因为分组其实是下一章我想讨论的内容。这里简单说一下就是第一个圆括号内的是第一个分组，如果我们对正则表达式查看第一个分组的话，就可以输出第一个圆括号内的所有内容。

![图片](https://uploader.shimo.im/f/888skrtpzdkcG0eP.png!thumbnail?fileGuid=3KhKJxP3DQDHPvvV)

还有一个叫做字符边界，用 "\b" 来表示。例如 abc\b 能匹配 abc，不能匹配 abcc。

### 总结

我想你应该有了基本的正则表达式的了解了。正则表达式通过简单的或和量词，能够匹配相应模式的字符串。同时，转义符号的加入，使得一些常用操作变得快捷，同时一些特殊字符也能得到匹配。

好！侦探们入门了！听令！我们要开始逮那些康你服务器的人了！现在是你基础教学的第一个问题！

### 试题

鼓励写出解题思路，思考过程。以下是一些在线正则表达式编辑。

* [Debuggex](https://link.zhihu.com/?target=https://www.debuggex.com/&fileGuid=3KhKJxP3DQDHPvvV)
* [PyRegex](http://pyregex.com/?fileGuid=3KhKJxP3DQDHPvvV)
* [Regexper](http://regexper.com/?fileGuid=3KhKJxP3DQDHPvvV)

#### Q1：

热个身：）

你的目的是找到那些说了安卓版本号的嫌疑人。

请写一个正则表达式，能够匹配所有安卓系统和版本号。例如，Android P， android 5，Android 1.6 ,android Marshmallow等，都应该被成功匹配。你需要自主找到所有的安卓版本号。非安卓版本号都不应该被匹配。

#### Q2：

数据！数据！没有确切的数据就试图捞出凶手，无异于大海捞针，纸上谈兵。

你的顾问团收集了嫌疑人的大量信息，你需要提炼出有趣的那些数据。换句话说，你需要写一个正则表达式，来匹配各种数字。举例来说，你需要匹配诸如

    * 3.14159
    * -255.34
    * 128
    * 1.8e10
    * -1.5E20
    * 123,340.09
    * 69
    * 0

而像

    * 3p
    * 3.14.13
    * 66，66，66
    * 0223.2

等不能被匹配。


## 进阶

前面说的这个匹配的概念很重要。很多教程不会强调**匹配**和**正则表达式输出字符串**这两个概念，所以很多初学者对于正则表达式的定位会造成很多误解。

常见的误解是，以为正则表达式类似函数，接受一个字符串，输出一个是或否的布尔变量。这个函数的过程理解成匹配。还有一种误解是，正则表达式是一个函数，接受一个字符串，输出一个字符串。实际上这两种理解都是片面的。正则表达式不仅仅能做到匹配，也能做到输出相应的字符串，甚至能修改原来的字符串！

这些概念难吗？至少对于我在学的过程中来说，这给我造成了很多困扰.....如果你觉得这对你很简单，那太棒了，**你比我聪明多了**！

接下来我们谈论的，就是类似于，接受一个字符串，输出感兴趣的部分字符串。

### 分组和引用

“不行！这不合理！”作为一个侦探，以一些口头说话习惯来定罪实在是对证据太不尊重了。你还是计划回归原来的登录日志，来找到切实的证据。

回到我们刚刚打印出来的log

```plain
Feb 07 00:03:35 hapkangde.com sshd[7223]: Invalid user webmail from 144.217.83.109 port 41292
Feb 07 23:16:27 haokangde.com sshd[481]: Disconnected from invalid user compta 62.210.69.91 port 47476 [preauth]
Feb 07 23:16:27 haokangde.com sshd[479]: Received disconnect from 70.45.243.146 port 43826:11: Bye Bye [preauth]
Feb 07 23:16:30 haokangde.com sshd[483]: Disconnected form invalid user preuba 70.
```

我们想要直接了当得得到每一个的用户名。其实分组在之前已经反复提到过了，就是每一个圆括号就是一个分组。而引用一个分组的内容，通过 "\1","\2" 这样的方式引用第一个或第二个分组。
我们想要找到每一行

```plain
Feb 07 23:16:27 haokangde.com sshd[481]: Disconnected from invalid user compta 62.210.69.91 port 47476 [preauth]
```

当中的用户名。即 user 后面的内容。
我们可以这样 /^.*Disconnected from invalid user (\w+)\s.*$/

然后通过 \1 就捕获了第一个分组的内容，也就是用户名。你可以给你的分组起一些好记的名字，怎么起呢？搜索引擎是你最好的老师。

恭喜你，你抓到凶手啦！让我们松口气，不如看看，你服务器上哪些人喜欢发可爱表情吧！

### 非贪婪匹配

你觉得 QAQ,QwQ,QaQ,QwwQ 都是可爱的表情。似乎两个Q之间夹杂任何东西都会变得很可爱。

怎样匹配这些内容？

你应该很容易想到正则表达式 /Q.*Q/ 表示匹配"Q"，之后是任意内容，之后再匹配一个"Q"。注意，其中匹配任意内容也可以是"Q"。

这造成了什么困难？如果是 "QAQSB$!%%@eww212Q" 这样的暴躁文字，你会匹配到从第一个"Q"到最后一个"Q"。很显然不只是第一个"QAQ"，从头到尾的Q也是符合 /Q.*Q/ 的定义的。而遗憾的是，正则表达式是贪婪匹配的。

如何规避这些？通过在句尾加上一个问号，可以使得字符串重复不再匹配最长字符。这便是非贪婪匹配。

所以我们可以使用 /Q.*?Q/ 来匹配Q后面的第一个Q

问号可以和量词一起使用，以下是非贪婪匹配的用法

* /*?/重复任意次，但尽可能少重复
* /+?/ 重复1次或更多次，但尽可能少重复
* /??/ 重复0次或1次，但尽可能少重复
* /{n,m}?/ 重复n到m次，但尽可能少重复
* /{n,}?/ 重复n次以上，但尽可能少重复

### 后向引用

只会 "QAQ" 也太不可爱了！真正的可爱应该说叠词词。

可是叠词词怎么识别呢？ QAQ 根本问题是前面的内容需要用到前面的内容。你会想到什么？分组？对！分组也可以直接写在正则表达式当中。

你想找到那些说叠词词的人，例如 "miao miao" 或者 "wu wu"。这样的方法很简单，就是/	\b(\w+)\b\s+\1\b/  还记得吗？/\b/ 表示的是字符边界。因此，这句正则的意思可以理解为，一个单词，空格，再重复这个单词。完美地契合了我们的需求。

### 编程语言

好像说了那么多没有谈到具体在哪里使用正则表达式。这是因为，正则表达式无处不在，从命令行的 sed awk 还是 Python 里的 re 库，都支持。事实上，你很难找到一个不支持正则表达式的语言（杠精禁止）。我们不想在习题里对你使用的语言做限制。

但是如果你感兴趣的话，这里有一些正则表达式在 Python里的应用实例。如果你不会 Python，也没有关系。

```python
import re
s='hello 1234567 world'
res = re.match('he.*?(\d+)\d.*rld$',s)
print(res.group(1))
// 结果：123456
```

### 总结

您现在已经是一个名副其实的擅长正则表达式的带侦探了。

还有些有趣的关于正则表达式的讨论

- [正则表达式30分钟入门教程](https://deerchao.cn/tutorials/regex/regex.htm?fileGuid=3KhKJxP3DQDHPvvV)

- [正则表达式判断素数](https://www.noulakaz.net/2007/03/18/a-regular-expression-to-check-for-prime-numbers/?fileGuid=3KhKJxP3DQDHPvvV)

- [匹配 email 地址](https://www.regular-expressions.info/email.html?fileGuid=3KhKJxP3DQDHPvvV)

- [图形化展示正则表达式](https://jex.im/regulex/#!flags=&re=%5E(a%7Cb)*%3F%24?fileGuid=3KhKJxP3DQDHPvvV)

- [正则表达式习题1](https://www.hackerrank.com/domains/regex?filters[subdomains][]=re-introduction&fileGuid=3KhKJxP3DQDHPvvV)

- [正则表达式习题2](https://regexone.com/problem?fileGuid=3KhKJxP3DQDHPvvV)

Enjoy the world with Regex!  ：）

### 试题

#### Q1：

热个身：）

你获得了连接上你的服务器的所有人的联系方式！现在，你愿意分享你的好康的东西给他们。你收集了你的粉丝们的手机号码，你想知道他们来自哪儿。假定我们的手机号书写有如下格式。左边是源号码，右边是你想要返回的字符串。

|  Telephone                    | 捕获组     |
| ------------------------------| ---------- |
| `415-555-1234`                | `415`      |
| `650-555-2345 `               | `650`      |
| `(416)555-3456`               | `416`      |
| `202 555 4567 `               | `202`      |
| `4035555678`                  | `403`      |
| `1 416 555 9292`              | `416`      |

#### Q2:

还是很简单的题：）

你获取了你的粉丝们的联系邮箱。你需要将邮件地址分为邮箱号和域名的第一部分两个group。你可以参考一下前面的匹配email地址的复习链接。

例如：

|  Telephone                         | 捕获组                  |
| -----------------------------------| ----------------------- |
| `tom@hogwarts.com`                 | `tom` `hogwarts`        |
| `tom.riddle@hogwarts.com`          | `tom.riddle` `hogwarts` |
| `tom.riddle+regexone@hogwarts.com` | `tom.riddle` `hogwarts` |
| `tom@hogwarts.eu.com`              | `tom` `hogwarts`        |
| `potter@hogwarts.com`              | `potter` `hogwarts`     |
| `harry@hogwarts.com`               | `harry` `hogwarts`      |
| `hermione+regexone@hogwarts.com`   | `hermione` `hogwarts`   |

#### Q3:

你如果发现进阶比基础简单，那就对了。因为出很难的正则其实意义不大，重要在培养熟练度。

你觉得直接通过访问服务器来康你的好康的不太优雅。你想用一个网页的形式展示一下。

你写过网页吗？网页的最最最基础是 HTML。它由标签（<tag>）组成，如果你不了解前端的话，其实也没有关系。你的目的是提取所有的标签名。就像下面这样。
   
|  HTML Tag                                     | 捕获组     |
| -------------------------------------------- -| ---------- |
| `<a>This is a link</a>`                       | `a`        |
| `<a href='https://regexone.com'>Link</a> `    | `a`        |
| `<div class='test_style'>Test</div>`          | `div`      |
| `<div>Hello <span>world</span></div>`         | `div`      |


#### Q4：

还记得我们刚刚说要提取他们的 .mp4 文件吗？让我们把这个问题具体一点。假如你想找出那些嫌疑人看的所有图片文件，你应该怎么办？

举例来说，你的正则表达式应匹配如下字符串，并捕获文件名和后缀名。

|  File Name                         | 捕获组                  |
| -----------------------------------| ----------------------- |
| `img0912.jpg`                      | `img0912` `jpg`         |
| `updated_img0912.png`              | `updated_img0912` `png` |
| `favicon.gif`                      | `favicon` `gif`         |
                                                                 

注意，以下字符串不能被匹配！

* documentation.html
* .bash_profile
* workspace.doc
* img0912.jpg.tmp
* access.lock

#### Q5：

网络！网络！网络！网络有协议、端口号...哦天呢，网络可真神奇！这节课的重点不是告诉你协议、域名、端口号的作用（当然鼓励你查一查做），而是给你一个统一资源定位符（URL），来请你提取相应的协议、域名、端口号。

对左边的字符串，相应捕获成右边的格式。


|  URL                                                          | 捕获组                            |
| --------------------------------------------------------------| --------------------------------- |
| `ftp://file_server.com:21/top_secret/life_changing_plans.pdf` | `ftp` `file_server.com ` `21`     |
| `https://regexone.com/lesson/introduction#section`            | `https`  `regexone.com`           |
| `file://localhost:4040/zip_file`                              | `file` `localhost` `4040`         |
| `https://s3cur3-server.com:9999/`                             | `https``s3cur3-server.com` `9999` |
| `market://search/angry%20birds`                               | `market` `search`                 |

#### Q6:

搞开发太累了........

你做了安卓模块的题目了吗？在安卓开发的时候，经常需要看开发日志。有些开发日志是重要的，有些则可以被忽略。我们需要提取重要的内容。

|  log                                                          | 捕获组                            |
| --------------------------------------------------------------| --------------------------------- |
| `E/( 1553):   at widget.List.makeView(ListView.java:1727)`    | `makeView` `ListView.java` `1727` |
| `E/( 1553):   at widget.List.fillDown(ListView.java:652)`     | `fillDown`  `ListView.java` `652` |
| `E/( 1553):   at widget.List.fillFrom(ListView.java:709)`     | `fillFrom` `ListView.java` `709`  |

这些字符串不能被匹配

* W/dalvikvm( 1553): threadid=1: uncaught exception
* E/( 1553): FATAL EXCEPTION: main
* E/( 1553): java.lang.StringIndexOutOfBoundsException
